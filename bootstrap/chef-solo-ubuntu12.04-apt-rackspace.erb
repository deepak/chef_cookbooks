# Copyright 2012, Deepak Kannan
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# have NOT tested this and have not used this on production
# was written for ubuntu 12.04 LTS
# based on the chef bootstrap script. 
# removed everything not essential for chef-solo. 
# mainly validation_key and databag encrypt key

bash -c '
<%= "export http_proxy=\"#{knife_config[:bootstrap_proxy]}\"" if knife_config[:bootstrap_proxy] -%>

# let some apt-get traffic flow through rackspace ServiceNet. 
# This is an internal rackspace cloud-server network. 
# traffic is not billed and it it faster as well
# some apt sources like security is on ubuntu not rackspace. will get billed for that
cp /etc/apt/sources.list /etc/apt/sources.list.old
sed -i 's/http:\/\/mirror\.rackspace\.com/http:\/\/snet1-dfw\.mirror\.rackspace.com/g' /etc/apt/sources.list
aptitude update # as sources were updated

# TODO: understand how debconf-set-selections works
if [ ! -f /usr/bin/chef-client ]; then
  aptitude install -y wget
  echo "chef	chef/chef_server_url	string	<%= @chef_config[:chef_server_url] %>" | debconf-set-selections
  [ -f /etc/apt/sources.list.d/opscode.list ] || echo "deb http://apt.opscode.com/ `lsb_release -cs`-0.10 main" | sudo tee /etc/apt/sources.list.d/opscode.list
  wget <%= "--proxy=on " if knife_config[:bootstrap_proxy] %>-O- http://apt.opscode.com/packages@opscode.com.gpg.key | apt-key add -
fi

# creates /etc/chef
aptitude install -y chef

'
