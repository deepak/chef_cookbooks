# Copyright 2012, Deepak Kannan
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# have tested on ubuntu 12.04 LTS only and is in use on production
# was written for ubuntu 12.04 LTS
# based on the chef bootstrap script. 
# removed everything not essential for chef-solo. 
# mainly validation_key and databag encrypt key

bash -c '
<%= "export http_proxy=\"#{knife_config[:bootstrap_proxy]}\"" if knife_config[:bootstrap_proxy] -%>

# let some apt-get traffic flow through rackspace ServiceNet. 
# This is an internal rackspace cloud-server network. 
# traffic is not billed and it it faster as well
# some apt sources like security is on ubuntu not rackspace. will get billed for that
cp /etc/apt/sources.list /etc/apt/sources.list.old
sed -i 's/http:\/\/mirror\.rackspace\.com/http:\/\/snet1-dfw\.mirror\.rackspace.com/g' /etc/apt/sources.list
aptitude update # as sources were updated

if [ ! -f /usr/bin/chef-client ]; then
  aptitude install -y ruby ruby1.8-dev build-essential wget libruby1.8 rubygems
fi

gem update --no-rdoc --no-ri
gem install ohai --no-rdoc --no-ri --verbose
gem install chef --no-rdoc --no-ri --verbose <%= bootstrap_version_string %>

mkdir -p /etc/chef

'
